# Phase 1: Rust + pgrx Infrastructure Setup

**Objective**: Convert jsonb_ivm from C to Rust using pgrx framework, establishing perfect quality foundation

**Status**: RED (TDD - write tests first)

---

## ğŸ¯ Scope

Replace C implementation with Rust + pgrx while maintaining 100% functional compatibility:
- Same API: `jsonb_merge_shallow(target, source)`
- Same behavior: All 12 existing tests must pass
- Better quality: Memory safety guaranteed by Rust compiler
- Modern tooling: cargo, clippy, rustfmt, CI/CD

**What Changes:**
- âŒ Remove: `jsonb_ivm.c`, C-based Makefile
- âœ… Add: Rust project structure, `Cargo.toml`, `src/lib.rs`
- âœ… Update: CI/CD workflows for Rust builds
- âœ… Keep: Same SQL tests, same expected output

---

## ğŸ“ Target File Structure

```
jsonb_ivm/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ test.yml              # Updated for pgrx
â”‚       â””â”€â”€ lint.yml              # Updated for cargo fmt/clippy
â”œâ”€â”€ .cargo/
â”‚   â””â”€â”€ config.toml               # Rust build configuration
â”œâ”€â”€ src/
â”‚   â””â”€â”€ lib.rs                    # Main Rust implementation
â”œâ”€â”€ sql/                          # SQL migration scripts (generated by pgrx)
â”‚   â””â”€â”€ jsonb_ivm--0.1.0.sql
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ sql/
â”‚   â”‚   â””â”€â”€ 01_merge_shallow.sql  # Same tests!
â”‚   â””â”€â”€ expected/
â”‚       â””â”€â”€ 01_merge_shallow.out  # Same expectations!
â”œâ”€â”€ Cargo.toml                    # Rust project manifest
â”œâ”€â”€ Cargo.lock                    # Dependency lock file
â”œâ”€â”€ .gitignore                    # Updated for Rust
â”œâ”€â”€ README.md                     # Updated with Rust instructions
â”œâ”€â”€ CHANGELOG.md                  # Note Rust migration
â”œâ”€â”€ LICENSE                       # Same
â””â”€â”€ .phases/                      # This directory
    â””â”€â”€ rust-migration/
        â”œâ”€â”€ phase-1-setup.md      # This file
        â”œâ”€â”€ phase-2-implement.md
        â”œâ”€â”€ phase-3-test.md
        â””â”€â”€ phase-4-cicd.md
```

---

## ğŸ› ï¸ Implementation Steps

### Step 1: Install Rust Toolchain

```bash
# Install rustup (if not already installed)
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env

# Verify installation
rustc --version
cargo --version
```

**Expected Output:**
```
rustc 1.83.0 (90b35a623 2024-11-26)
cargo 1.83.0 (5ffbef321 2024-10-29)
```

---

### Step 2: Install cargo-pgrx

```bash
# Install pgrx CLI tool
cargo install --locked cargo-pgrx

# Initialize pgrx with PostgreSQL versions 13-17
cargo pgrx init --pg13 download --pg14 download --pg15 download --pg16 download --pg17 download
```

**Notes:**
- `--pg<ver> download` tells pgrx to download and compile PostgreSQL versions
- This takes ~30 minutes first time (one-time setup)
- Alternative: `--pg17 /usr/lib/postgresql/17/bin/pg_config` to use system PostgreSQL

**Expected Output:**
```
  Installed pgrx v0.12.8
  Configuring pgrx for PostgreSQL 13, 14, 15, 16, 17...
  Downloading PostgreSQL sources...
  âœ“ PostgreSQL 13.x configured
  âœ“ PostgreSQL 14.x configured
  âœ“ PostgreSQL 15.x configured
  âœ“ PostgreSQL 16.x configured
  âœ“ PostgreSQL 17.x configured
```

---

### Step 3: Initialize Rust Project

```bash
cd /home/lionel/code/jsonb_ivm

# Backup current C files (in case we need to reference)
mkdir .archive-c-implementation
mv jsonb_ivm.c jsonb_ivm.control jsonb_ivm--0.1.0.sql Makefile .archive-c-implementation/

# Initialize pgrx project
cargo pgrx new jsonb_ivm
# This creates a template - we'll move files to root
```

**Wait - better approach**: Initialize in-place:

```bash
# Initialize Cargo.toml manually (cleaner)
cat > Cargo.toml << 'EOF'
[package]
name = "jsonb_ivm"
version = "0.1.0"
edition = "2021"
authors = ["Lionel Hamayon <lionel.hamayon@evolution-digitale.fr>"]
license = "PostgreSQL"
description = "Incremental JSONB View Maintenance for CQRS Architectures"
homepage = "https://github.com/fraiseql/jsonb_ivm"
repository = "https://github.com/fraiseql/jsonb_ivm"
keywords = ["postgresql", "jsonb", "materialized-view", "cqrs", "incremental"]
categories = ["database"]

[lib]
crate-type = ["cdylib"]

[dependencies]
pgrx = "0.12.8"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

[dev-dependencies]
pgrx-tests = "0.12.8"

[profile.release]
opt-level = 3
lto = "fat"
codegen-units = 1

[profile.dev]
opt-level = 0

# pgrx extension configuration
[package.metadata.pgrx]
EOF
```

---

### Step 4: Create Rust Source Structure

```bash
# Create src directory
mkdir -p src

# Create lib.rs (main implementation file)
cat > src/lib.rs << 'EOF'
// jsonb_ivm - Incremental JSONB View Maintenance Extension
//
// High-performance PostgreSQL extension for intelligent partial updates
// of JSONB materialized views in CQRS architectures.
//
// Copyright (c) 2025, Lionel Hamayon
// Licensed under the PostgreSQL License

use pgrx::prelude::*;

// Tell pgrx which PostgreSQL versions we support
pgrx::pg_module_magic!();

#[cfg(any(test, feature = "pg_test"))]
#[pg_schema]
mod tests {
    use pgrx::prelude::*;

    #[pg_test]
    fn test_basic_merge() {
        // Integration tests will be added in Phase 3
        assert!(true);
    }
}

// Main extension code will be added in Phase 2
EOF
```

---

### Step 5: Configure Cargo Build Settings

```bash
# Create .cargo/config.toml for build optimization
mkdir -p .cargo
cat > .cargo/config.toml << 'EOF'
[build]
# Use all CPU cores for parallel compilation
jobs = 8

[target.x86_64-unknown-linux-gnu]
# Link-time optimization
rustflags = ["-C", "link-arg=-fuse-ld=lld"]

[profile.release]
# Maximum optimization for production builds
opt-level = 3
lto = "fat"
codegen-units = 1
strip = true

[profile.dev]
# Fast compilation for development
opt-level = 0
debug = true
EOF
```

---

### Step 6: Update .gitignore for Rust

```bash
# Update .gitignore with Rust-specific entries
cat >> .gitignore << 'EOF'

# Rust
/target/
Cargo.lock
**/*.rs.bk
*.pdb

# pgrx
/.pgrx/
/sql/*.generated.sql
EOF
```

---

### Step 7: Initialize pgrx Schema

```bash
# Generate pgrx configuration
cargo pgrx schema

# This creates:
# - sql/jsonb_ivm--0.1.0.sql (generated from Rust code)
# - Registers extension with PostgreSQL
```

**Expected Output:**
```
Generating SQL for jsonb_ivm...
  âœ“ sql/jsonb_ivm--0.1.0.sql
```

---

### Step 8: Verify Build Environment

```bash
# Test that basic build works
cargo build --release

# This should compile successfully (even with empty lib.rs)
```

**Expected Output:**
```
   Compiling pgrx v0.12.8
   Compiling jsonb_ivm v0.1.0
    Finished release [optimized] target(s) in 45.2s
```

---

## âœ… Acceptance Criteria

**This phase is complete when:**

- [ ] Rust toolchain installed (rustc, cargo)
- [ ] cargo-pgrx installed and initialized
- [ ] `Cargo.toml` created with correct metadata
- [ ] `src/lib.rs` created with pgrx boilerplate
- [ ] `.cargo/config.toml` configured for optimized builds
- [ ] `.gitignore` updated for Rust artifacts
- [ ] `cargo build --release` succeeds
- [ ] `cargo pgrx schema` generates SQL file
- [ ] Old C files archived in `.archive-c-implementation/`

---

## ğŸš« DO NOT

- âŒ Implement `jsonb_merge_shallow` yet (Phase 2)
- âŒ Write tests yet (Phase 3)
- âŒ Update CI/CD yet (Phase 4)
- âŒ Delete C backup files permanently
- âŒ Commit to git yet (wait until Phase 4 complete)

---

## ğŸ“ Verification Commands

```bash
# Check Rust is installed
rustc --version
cargo --version

# Check pgrx is installed
cargo pgrx --version

# Check project builds
cargo build --release

# Check pgrx can generate schema
cargo pgrx schema

# Verify file structure
tree -L 2 -I 'target'
```

**Expected tree output:**
```
.
â”œâ”€â”€ .cargo
â”‚   â””â”€â”€ config.toml
â”œâ”€â”€ .github
â”‚   â””â”€â”€ workflows
â”œâ”€â”€ .gitignore
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ src
â”‚   â””â”€â”€ lib.rs
â””â”€â”€ test
    â”œâ”€â”€ expected
    â””â”€â”€ sql
```

---

## â­ï¸ Next Phase

**Phase 2**: Implement `jsonb_merge_shallow` in Rust with pgrx
- Translate C logic to Rust
- Use pgrx's `JsonB` type
- Maintain exact same behavior
- Compiler-verified memory safety

---

**Context**: This is Phase 1 of 4 in the Rust migration plan. We're building the foundation for a quality-first PostgreSQL extension using modern, memory-safe tooling.
