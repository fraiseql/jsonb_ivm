name: Security & Compliance

# Comprehensive security and compliance checks for Rust PostgreSQL extension
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly security scans (every Monday at 2 AM UTC)
    - cron: '0 2 * * 1'
  workflow_dispatch:

concurrency:
  group: security-compliance-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF to Code Scanning
  actions: read

jobs:
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    # Only run on pull requests where there's always a diff to scan
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.pull_request.base.sha }}
        head: ${{ github.event.pull_request.head.sha }}
        extra_args: --debug --only-verified

  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-license-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-license
      run: cargo install cargo-license

    - name: Scan Rust package licenses
      run: |
        echo "=== Rust Package Licenses ==="
        cargo license --json > rust-licenses.json
        cargo license --tsv > rust-licenses.tsv
        cat rust-licenses.tsv

    - name: Check for GPL licenses
      run: |
        # Check for GPL licenses (excluding LGPL and multi-licensed packages)
        GPL_PACKAGES=$(grep -i "GPL" rust-licenses.tsv | grep -v -i "LGPL" | grep -v "MIT OR Apache-2.0 OR GPL" || true)

        if [ -n "$GPL_PACKAGES" ]; then
          echo "âš ï¸  GPL-licensed packages found:"
          echo "$GPL_PACKAGES"
          echo ""
          echo "â„¹ï¸  Review these packages to ensure compliance with project license policy"
          echo "â„¹ï¸  PostgreSQL License is compatible with most permissive licenses"
          # Don't fail - just warn (PostgreSQL ecosystem may have GPL tools)
          exit 0
        else
          echo "âœ… No strict GPL licenses found"
        fi

    - name: Upload license report
      uses: actions/upload-artifact@v5
      with:
        name: license-report
        path: |
          rust-licenses.json
          rust-licenses.tsv

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-audit-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-audit
      run: cargo install cargo-audit --locked

    - name: Audit Rust dependencies
      run: |
        echo "=== Rust Security Advisory Database Scan ==="
        cargo audit --json > audit-results.json || true
        cargo audit || true

    - name: Check for critical vulnerabilities
      run: |
        if [ -f audit-results.json ]; then
          # Check if there are any vulnerabilities
          VULN_COUNT=$(jq '.vulnerabilities.found | length' audit-results.json)
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "ðŸš¨ $VULN_COUNT vulnerabilities found!"
            jq '.vulnerabilities.list' audit-results.json
            echo ""
            echo "Run 'cargo audit --fix' to update vulnerable dependencies"
            exit 1
          else
            echo "âœ… No known vulnerabilities found"
          fi
        else
          echo "â„¹ï¸  No audit results generated (clean scan)"
        fi

    - name: Upload audit results
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: dependency-audit-results
        path: audit-results.json

  compliance-check:
    name: Compliance Validation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Check SECURITY.md exists
      run: |
        if [ ! -f "SECURITY.md" ]; then
          echo "âŒ SECURITY.md file is missing"
          exit 1
        fi
        echo "âœ… Security policy exists"

    - name: Check CODE_OF_CONDUCT.md exists
      run: |
        if [ ! -f "CODE_OF_CONDUCT.md" ]; then
          echo "âŒ CODE_OF_CONDUCT.md file is missing"
          exit 1
        fi
        echo "âœ… Code of Conduct exists"

    - name: Check for required files
      run: |
        required_files=("LICENSE" "README.md" "CHANGELOG.md" "CONTRIBUTING.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Required file $file is missing"
            exit 1
          fi
        done
        echo "âœ… All required compliance files present"

    - name: Validate Cargo.lock is committed
      run: |
        if [ ! -f "Cargo.lock" ]; then
          echo "âŒ Cargo.lock must be committed for reproducible builds"
          exit 1
        fi
        echo "âœ… Cargo.lock is committed (reproducible builds enabled)"

    - name: Check for unsafe code usage
      run: |
        echo "=== Checking for unsafe code blocks ==="
        UNSAFE_COUNT=$(grep -r "unsafe" src/ --include="*.rs" | wc -l || echo "0")
        echo "Found $UNSAFE_COUNT unsafe code blocks"

        if [ "$UNSAFE_COUNT" -gt 0 ]; then
          echo ""
          echo "âš ï¸  Unsafe code detected (review required):"
          grep -n "unsafe" src/ --include="*.rs" || true
          echo ""
          echo "â„¹ï¸  Unsafe code is acceptable in PostgreSQL extensions (pgrx requirements)"
          echo "â„¹ï¸  Ensure all unsafe blocks are:"
          echo "   - Documented with safety invariants"
          echo "   - Minimized in scope"
          echo "   - Required by pgrx or PostgreSQL C API"
        else
          echo "âœ… No unsafe code found (100% safe Rust)"
        fi

  supply-chain-metadata:
    name: Supply Chain Metadata
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Generate dependency tree
      run: |
        cargo tree > dependency-tree.txt
        echo "=== Dependency Tree ==="
        cat dependency-tree.txt

    - name: Count dependencies
      run: |
        DIRECT_DEPS=$(grep -c "^[a-z]" Cargo.toml || echo "0")
        TOTAL_DEPS=$(cargo tree --depth 999 | grep -c "â”œâ”€â”€\|â””â”€â”€" || echo "0")

        echo "ðŸ“¦ Direct dependencies: $DIRECT_DEPS"
        echo "ðŸ“¦ Total dependencies (with transitive): $TOTAL_DEPS"

        # jsonb_ivm should have minimal dependencies (target: <50 total)
        if [ "$TOTAL_DEPS" -gt 100 ]; then
          echo "âš ï¸  High dependency count detected (review recommended)"
        else
          echo "âœ… Minimal dependency footprint"
        fi

    - name: Upload dependency tree
      uses: actions/upload-artifact@v5
      with:
        name: dependency-tree
        path: dependency-tree.txt

  miri-test:
    name: MIRI (Memory Safety)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust nightly with MIRI
      run: |
        rustup toolchain install nightly --component miri
        rustup override set nightly

    - name: Run MIRI tests
      run: |
        echo "=== Running MIRI for Undefined Behavior Detection ==="
        cargo miri test --lib --no-default-features --features pg_test || {
          echo "âŒ MIRI found undefined behavior!"
          echo ""
          echo "This indicates potential memory safety issues:"
          echo "  - Use-after-free"
          echo "  - Buffer overflows"
          echo "  - Invalid pointer dereferences"
          echo "  - Data races"
          echo ""
          echo "Review unsafe code blocks and fix issues"
          exit 1
        }
        echo "âœ… No undefined behavior detected by MIRI"

  memory-sanitizers:
    name: Memory Sanitizers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sanitizer: [address, leak, thread]
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@nightly

    - name: Run ${{ matrix.sanitizer }} sanitizer
      env:
        RUSTFLAGS: "-Z sanitizer=${{ matrix.sanitizer }}"
        RUSTDOCFLAGS: "-Z sanitizer=${{ matrix.sanitizer }}"
      run: |
        echo "=== Running ${{ matrix.sanitizer }} sanitizer ==="
        cargo +nightly test --lib --target x86_64-unknown-linux-gnu \
          --no-default-features --features pg_test || {
          echo "âŒ ${{ matrix.sanitizer }} sanitizer found issues!"
          exit 1
        }
        echo "âœ… No issues found with ${{ matrix.sanitizer }} sanitizer"

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t jsonb_ivm:scan .

      - name: Run Trivy scan (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'jsonb_ivm:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: 0
          trivyignores: '.trivyignore'

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy scan (JSON for analysis)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'jsonb_ivm:scan'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          trivyignores: '.trivyignore'

      - name: Check for CRITICAL vulnerabilities
        run: |
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)

          echo "ðŸ” Vulnerability Summary:"
          echo "   CRITICAL: $CRITICAL"
          echo "   HIGH: $HIGH"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ CRITICAL vulnerabilities found - failing build"
            jq '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")' trivy-results.json
            exit 1
          elif [ "$HIGH" -gt 0 ]; then
            echo "âš ï¸  HIGH vulnerabilities found - review .trivyignore"
            jq '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")' trivy-results.json
          else
            echo "âœ… No CRITICAL or HIGH vulnerabilities"
          fi

      - name: Upload Trivy results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: trivy-scan-results
          path: trivy-results.json

  security-gate:
    name: Security Gate âœ…
    runs-on: ubuntu-latest
    needs: [secrets-scan, license-scan, dependency-audit, compliance-check, supply-chain-metadata, miri-test, memory-sanitizers, container-security]
    if: always()
    steps:
      - name: Security compliance check
        run: |
          # Check if all security jobs passed
          # secrets-scan is skipped on push events (only runs on PRs) - that's OK
          if [[ "${{ needs.secrets-scan.result }}" != "success" && "${{ needs.secrets-scan.result }}" != "skipped" ]]; then
            echo "âŒ Secrets scan failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.license-scan.result }}" != "success" ]]; then
            echo "âŒ License compliance failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.dependency-audit.result }}" != "success" ]]; then
            echo "âŒ Dependency audit failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.compliance-check.result }}" != "success" ]]; then
            echo "âŒ Compliance validation failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.supply-chain-metadata.result }}" != "success" ]]; then
            echo "âŒ Supply chain metadata failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.miri-test.result }}" != "success" ]]; then
            echo "âŒ MIRI tests failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.memory-sanitizers.result }}" != "success" ]]; then
            echo "âŒ Memory sanitizers failed - Security gate blocked"
            exit 1
          fi
          if [[ "${{ needs.container-security.result }}" != "success" ]]; then
            echo "âŒ Container security scan failed - Security gate blocked"
            exit 1
          fi
          echo "âœ… All security and compliance checks passed - Security gate open"
          echo "ðŸ”’ Code meets security and compliance standards (A+ GRADE)"
