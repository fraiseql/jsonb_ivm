name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: PostgreSQL ${{ matrix.pg-version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        pg-version: [13, 14, 15, 16, 17, 18]
        os: [ubuntu-latest, macos-latest]
        exclude:
          # macOS testing is expensive, only test latest PG
          - os: macos-latest
            pg-version: 13
          - os: macos-latest
            pg-version: 14
          - os: macos-latest
            pg-version: 15
          - os: macos-latest
            pg-version: 16
          - os: macos-latest
            pg-version: 17

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install PostgreSQL ${{ matrix.pg-version }}
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            # Add PostgreSQL APT repository
            sudo apt-get install -y wget gnupg
            sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
            wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -

            sudo apt-get update
            sudo apt-get install -y \
              postgresql-${{ matrix.pg-version }} \
              postgresql-server-dev-${{ matrix.pg-version }}

            # Create and start cluster if it doesn't exist, or start if exists but down
            if ! sudo pg_lsclusters -h | grep -q "^${{ matrix.pg-version }} main"; then
              # Cluster doesn't exist, create it
              sudo pg_createcluster ${{ matrix.pg-version }} main --start || true
            else
              # Cluster exists, ensure it's running
              sudo pg_ctlcluster ${{ matrix.pg-version }} main start || true
            fi

            # Verify cluster is running
            sudo pg_lsclusters
            sudo -u postgres psql -c "SELECT version();" || echo "PostgreSQL not ready yet"
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install postgresql@${{ matrix.pg-version }}
            brew services start postgresql@${{ matrix.pg-version }}
            echo "/usr/local/opt/postgresql@${{ matrix.pg-version }}/bin" >> $GITHUB_PATH
          fi

      - name: Install cargo-pgrx
        run: |
          cargo install --locked cargo-pgrx --version 0.16.1

      - name: Initialize pgrx
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            cargo pgrx init --pg${{ matrix.pg-version }}=/usr/lib/postgresql/${{ matrix.pg-version }}/bin/pg_config
          elif [ "$RUNNER_OS" == "macOS" ]; then
            cargo pgrx init --pg${{ matrix.pg-version }}=/usr/local/opt/postgresql@${{ matrix.pg-version }}/bin/pg_config
          fi

      - name: Build extension
        run: |
          cargo build --release --locked --no-default-features --features pg${{ matrix.pg-version }}

      - name: Install extension
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            cargo pgrx install --pg-config=/usr/lib/postgresql/${{ matrix.pg-version }}/bin/pg_config --release --sudo
          elif [ "$RUNNER_OS" == "macOS" ]; then
            cargo pgrx install --pg-config=/usr/local/opt/postgresql@${{ matrix.pg-version }}/bin/pg_config --release --sudo
          fi

      - name: Run SQL integration tests
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            # Get the port for this PostgreSQL version
            PG_PORT=$(sudo pg_lsclusters -h | grep "^${{ matrix.pg-version }} main" | awk '{print $3}')
            echo "Using PostgreSQL on port $PG_PORT"

            sudo -u postgres psql -p "$PG_PORT" -c "DROP DATABASE IF EXISTS test_jsonb_ivm;" || true
            sudo -u postgres psql -p "$PG_PORT" -c "CREATE DATABASE test_jsonb_ivm;"
          elif [ "$RUNNER_OS" == "macOS" ]; then
            psql -c "DROP DATABASE IF EXISTS test_jsonb_ivm;" || true
            psql -c "CREATE DATABASE test_jsonb_ivm;"
          fi

          # Create extension
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo -u postgres psql -p "$PG_PORT" -d test_jsonb_ivm -c "CREATE EXTENSION jsonb_ivm;"
          else
            psql -d test_jsonb_ivm -c "CREATE EXTENSION jsonb_ivm;"
          fi

          # Run all test files
          for test_file in test/sql/*.sql; do
            echo "Running $test_file..."
            if [ "$RUNNER_OS" == "Linux" ]; then
              sudo -u postgres psql -p "$PG_PORT" -d test_jsonb_ivm -f "$test_file" > "test_output_$(basename $test_file).txt" 2>&1
            elif [ "$RUNNER_OS" == "macOS" ]; then
              psql -d test_jsonb_ivm -f "$test_file" > "test_output_$(basename $test_file).txt" 2>&1
            fi

            if [ $? -ne 0 ]; then
              echo "❌ FAILED: $test_file"
              cat "test_output_$(basename $test_file).txt"
              exit 1
            else
              echo "✅ PASSED: $test_file"
            fi
          done

          # Run v0.1.0 smoke tests
          echo "Running v0.1.0 smoke tests..."
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo -u postgres psql -p "$PG_PORT" -d test_jsonb_ivm -f test/smoke_test_v0.1.0.sql > test_output_smoke_v0.1.0.txt 2>&1
          elif [ "$RUNNER_OS" == "macOS" ]; then
            psql -d test_jsonb_ivm -f test/smoke_test_v0.1.0.sql > test_output_smoke_v0.1.0.txt 2>&1
          fi

          if [ $? -ne 0 ]; then
            echo "❌ FAILED: v0.1.0 smoke tests"
            cat test_output_smoke_v0.1.0.txt
            exit 1
          else
            echo "✅ PASSED: v0.1.0 smoke tests"
          fi

      - name: Validate SQL schema generation
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            # Get the port for this PostgreSQL version
            PG_PORT=$(sudo pg_lsclusters -h | grep "^${{ matrix.pg-version }} main" | awk '{print $3}')
            echo "Using PostgreSQL on port $PG_PORT for schema generation"

            # Set PGPORT for pgrx to use
            export PGPORT=$PG_PORT
          fi

          # Generate schema using the correct PostgreSQL version
          cargo pgrx schema pg${{ matrix.pg-version }} > /tmp/generated-schema.sql

          # Check if schema matches committed version
          if ! diff -u sql/jsonb_ivm--0.1.0.sql /tmp/generated-schema.sql; then
            echo "❌ Generated schema doesn't match committed version!"
            echo "Run: cargo pgrx schema > sql/jsonb_ivm--0.1.0.sql"
            exit 1
          fi

          echo "✅ Schema generation validated"

      - name: Generate coverage report
        if: matrix.pg-version == 17 && matrix.os == 'ubuntu-latest' && (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'coverage'))
        run: |
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml --output-dir ./coverage

      - name: Upload to Codecov
        if: matrix.pg-version == 17 && matrix.os == 'ubuntu-latest' && (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'coverage'))
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/cobertura.xml

      - name: Check coverage threshold
        if: matrix.pg-version == 17 && matrix.os == 'ubuntu-latest' && (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'coverage'))
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq

          # Generate JSON coverage report
          cargo tarpaulin --out Json --output-dir ./coverage

          # Extract coverage percentage
          COVERAGE=$(jq -r '.coverage' ./coverage/coverage.json)

          echo "Current coverage: ${COVERAGE}%"

          # Check if coverage meets 80% threshold
          if (( $(echo "${COVERAGE} < 80.0" | bc -l) )); then
            echo "❌ ERROR: Code coverage ${COVERAGE}% is below 80% threshold"
            exit 1
          else
            echo "✅ Code coverage ${COVERAGE}% meets 80% threshold"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-pg${{ matrix.pg-version }}
          path: |
            test_output_*.txt
          if-no-files-found: ignore
