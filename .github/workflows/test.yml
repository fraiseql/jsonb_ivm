name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: PostgreSQL ${{ matrix.pg-version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        pg-version: [13, 14, 15, 16, 17]
        os: [ubuntu-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache pgrx
        uses: actions/cache@v4
        with:
          path: |
            ~/.pgrx
          key: ${{ runner.os }}-pgrx-${{ matrix.pg-version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-pgrx-${{ matrix.pg-version }}-
            ${{ runner.os }}-pgrx-

      - name: Install PostgreSQL ${{ matrix.pg-version }}
        run: |
          # Add PostgreSQL APT repository
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -

          sudo apt-get update
          sudo apt-get install -y \
            postgresql-${{ matrix.pg-version }} \
            postgresql-server-dev-${{ matrix.pg-version }} \
            libreadline-dev

      - name: Install cargo-pgrx
        run: |
          cargo install --locked cargo-pgrx --version 0.13.1

      - name: Initialize pgrx
        run: |
          cargo pgrx init --pg${{ matrix.pg-version }}=/usr/lib/postgresql/${{ matrix.pg-version }}/bin/pg_config

      - name: Build extension
        run: |
          cargo build --release --locked --no-default-features --features "pg${{ matrix.pg-version }}"

      - name: Install extension
        run: |
          sudo -E env "PATH=$PATH" $(which cargo) pgrx install --pg-config=/usr/lib/postgresql/${{ matrix.pg-version }}/bin/pg_config --release --no-default-features --features "pg${{ matrix.pg-version }}"

      - name: Run SQL integration tests
        run: |
          # Initialize and start PostgreSQL cluster
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg-version }}/bin/initdb -D /tmp/pgdata-${{ matrix.pg-version }} || true
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg-version }}/bin/pg_ctl -D /tmp/pgdata-${{ matrix.pg-version }} -l /tmp/pg-${{ matrix.pg-version }}.log start
          sleep 3
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg-version }}/bin/psql -h localhost -c "DROP DATABASE IF EXISTS test_jsonb_ivm;" || true
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg-version }}/bin/psql -h localhost -c "CREATE DATABASE test_jsonb_ivm;"

          # Create extension
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg-version }}/bin/psql -h localhost -d test_jsonb_ivm -c "CREATE EXTENSION jsonb_ivm;"

          # Copy test files to accessible location for postgres user
          sudo mkdir -p /tmp/test_files
          sudo cp -r test/sql /tmp/test_files/
          sudo cp test/smoke_test_v0.3.0.sql /tmp/test_files/
          sudo chown -R postgres:postgres /tmp/test_files

          # Run all test files
          for test_file in test/sql/*.sql; do
            echo "Running $test_file..."
            test_basename=$(basename "$test_file")
            sudo -u postgres /usr/lib/postgresql/${{ matrix.pg-version }}/bin/psql -h localhost -d test_jsonb_ivm -f "/tmp/test_files/sql/$test_basename" > "test_output_$test_basename.txt" 2>&1

            if [ $? -ne 0 ]; then
              echo "❌ FAILED: $test_file"
              cat "test_output_$test_basename.txt"
              exit 1
            else
              echo "✅ PASSED: $test_file"
            fi
          done

          # Run v0.3.0 smoke tests
          echo "Running v0.3.0 smoke tests..."
          sudo -u postgres /usr/lib/postgresql/${{ matrix.pg-version }}/bin/psql -h localhost -d test_jsonb_ivm -f /tmp/test_files/smoke_test_v0.3.0.sql > test_output_smoke_v0.3.0.txt 2>&1

          if [ $? -ne 0 ]; then
            echo "❌ FAILED: v0.3.0 smoke tests"
            cat test_output_smoke_v0.3.0.txt
            exit 1
          else
            echo "✅ PASSED: v0.3.0 smoke tests"
          fi

      - name: Validate SQL schema generation
        run: |
          # Fix ownership of target directory (may have been created by sudo install)
          sudo chown -R $USER:$USER target/ || true

          # Generate schema and compare with committed version
          cargo pgrx schema --no-default-features --features "pg${{ matrix.pg-version }}" > /tmp/generated-schema.sql

          # Check if schema matches committed version
          if ! diff -u sql/jsonb_ivm--0.3.0.sql /tmp/generated-schema.sql; then
            echo "❌ Generated schema doesn't match committed version!"
            echo "Run: cargo pgrx schema --no-default-features --features pg${{ matrix.pg-version }} > sql/jsonb_ivm--0.3.0.sql"
            exit 1
          fi

          echo "✅ Schema generation validated"

      - name: Generate coverage report
        if: matrix.pg-version == 17 && matrix.os == 'ubuntu-latest' && (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'coverage'))
        run: |
          cargo install cargo-tarpaulin
           cargo tarpaulin --out Xml --output-dir ./coverage

      - name: Upload to Codecov
        if: matrix.pg-version == 17 && matrix.os == 'ubuntu-latest' && (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'coverage'))
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/cobertura.xml

      - name: Check coverage threshold
        if: matrix.pg-version == 17 && matrix.os == 'ubuntu-latest' && (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'coverage'))
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq

          # Generate JSON coverage report
          cargo tarpaulin --out Json --output-dir ./coverage

          # Extract coverage percentage
          COVERAGE=$(jq -r '.coverage' ./coverage/coverage.json)

          echo "Current coverage: ${COVERAGE}%"

          # Check if coverage meets 80% threshold
          if (( $(echo "${COVERAGE} < 80.0" | bc -l) )); then
            echo "❌ ERROR: Code coverage ${COVERAGE}% is below 80% threshold"
            exit 1
          else
            echo "✅ Code coverage ${COVERAGE}% meets 80% threshold"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-pg${{ matrix.pg-version }}
          path: |
            test_output_*.txt
          if-no-files-found: ignore
